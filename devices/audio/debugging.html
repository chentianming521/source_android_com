<!DOCTYPE html>











































































































<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<meta name="Description" content="This article describes some tips and tricks for debugging Android audio. The &quot;tee sink&quot; is an AudioFlinger debugging feature, available in custom builds only, for retaining a short fragment of recent audio for later analysis. This permits comparisonâ€¦">

<link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico" />
<title>Audio Debugging | Android Open Source Project</title>

<!-- STYLESHEETS -->
<link rel="stylesheet"
href="https://fonts.googleapis.com/css?family=Roboto:regular,medium,thin,italic,mediumitalic,bold" title="roboto">
<link href="../../assets/css/default.css" rel="stylesheet" type="text/css">



<!-- JAVASCRIPT -->
<script src="https://www.google.com/jsapi" type="text/javascript"></script>
<script src="../../assets/js/android_3p-bundle.js" type="text/javascript"></script>
<script type="text/javascript">
  var toRoot = "/";
  
  var devsite = false;
  
</script>
<script src="../../assets/js/docs.js" type="text/javascript"></script>

<script src="../../navtree_data.js" type="text/javascript"></script>


<script type="text/javascript" src="https://www.gstatic.com/feedback/api.js"></script>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-45455297-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body class="gc-documentation 
  " itemscope itemtype="http://schema.org/Article">
<a name="top"></a>

  
    <!-- Header -->
    <div id="header">
        <div class="wrap" id="header-wrap">
          <div class="col-3 saclogo">
          <a href="../../index.html">
            <img src="../../assets/images/sac_logo.png"
                srcset="/assets/images/sac_logo@2x.png 2x"
                width="123" height="25" alt="Android Open Source Project" />
          </a>
          </div>
            <ul class="nav-x col-9">
                <li class="source">
                  <a href="../../source/index.html" 
                  >Source</a></li>
                <li class="devices"><a href="../index.html" class="selected"
                  >Devices</a></li>
                <li class="security"><a href="../../security/index.html" 
                  >Security</a></li>
                <li class="compatibility last"><a href="../../compatibility/index.html" 
                  >Compatibility</a></li>
            </ul>
            <!-- New Search -->
            <div class="menu-container">
            <div class="moremenu">
    <div id="more-btn"></div>
  </div>
  <div class="morehover" id="moremenu">
    <div class="top"></div>
    <div class="mid">
      <div class="header">Android Sites</div>
      <ul>
        <li class="active"><a>Android Open Source Project</a></li>
        <li><a href="http://www.android.com">Android.com</a></li>
        <li><a href="http://developer.android.com">Android Developers</a></li>
      </ul>
      <!-- <div class="header">Support</div>
      <ul>
        <li><a href="/support.html">Developer Support</a></li>
      </ul> -->
      <br class="clearfix" />
    </div>
    <div class="bottom"></div>
  </div>

  <div class="search" id="search-container">
    <div class="search-inner">
      <div id="search-btn"></div>
      <div class="left"></div>
      <form onsubmit="return submit_search()">
        <input id="search_autocomplete" type="text" value="" autocomplete="off" name="q"
onfocus="search_focus_changed(this, true)" onblur="search_focus_changed(this, false)"
onkeydown="return search_changed(event, true, '/')"
onkeyup="return search_changed(event, false, '/')" />
      </form>
      <div class="right"></div>
        <a class="close hide">close</a>
        <div class="left"></div>
        <div class="right"></div>
    </div>
  </div>
  <div id="search_filtered_wrapper">
    <div id="search_filtered_div" class="no-display">
        <ul id="search_filtered">
        </ul>
    </div>
  </div>

  </div>
  <!-- /New Search> -->
        </div>
    </div>
    <!-- /Header -->

  <div id="searchResults" class="wrap" style="display:none;">
          <h2 id="searchTitle">Results</h2>
          <div id="leftSearchControl" class="search-control">Loading...</div>
  </div>

  
  
  
    
  <div class="wrap clearfix" id="body-content">
    <div class="col-4" id="side-nav" itemscope itemtype="http://schema.org/SiteNavigationElement">
      <div id="devdoc-nav" class="scroll-pane">
<a class="totop" href="debugging.html#top" data-g-event="left-nav-top">to top</a>

<!--
    Copyright 2015 The Android Open Source Project

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<ul id="nav">
  <li class="nav-section">  <!-- Begin nav section, Device Interfaces -->
    <div class="nav-section-header">
      <a href="../index.html">
        <span class="en">Interfaces</span>
      </a>
    </div>
    <ul>
  <li class="nav-section">
  <div class="nav-section-header">
      <a href="../accessories/index.html">
        <span class="en">Accessories</span>
      </a>
    </div>
    <ul>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../accessories/audio.html">
            <span class="en">Audio Accessories</span>
          </a>
        </div>
        <ul>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../accessories/headset/index.html">
            <span class="en">Headset</span>
          </a>
        </div>
        <ul>
          <li><a href="../accessories/headset/specification.html">Specification</a></li>
          <li><a href="../accessories/headset/requirements.html">Requirements</a></li>
          <li><a href="../accessories/headset/testing.html">Testing</a></li>
        </ul>
      </li>
        </ul>
      </li>
  <li class="nav-section">
  <div class="nav-section-header">
      <a href="../accessories/custom.html">
        <span class="en">Custom Accessories</span>
      </a>
    </div>
    <ul>
      <li class="nav-section">
        <div class="nav-section-header"><a href="../accessories/protocol.html"><span class="en">AOA</span>
        </a>
        </div>
        <ul>
          <li><a href="../accessories/aoa2.html">AOA 2.0</a></li>
          <li><a href="../accessories/aoa.html">AOA 1.0</a></li>
        </ul>
        </li>
        <div class="nav-section-header"><a href="../accessories/stylus.html"><span class="en">Stylus</span>
        </a>
        </div>
       </ul>
     </li>
    </ul>
      <li class="nav-section">
      <div class="nav-section-header">
        <a href="index.html">
          <span class="en">Audio</span>
        </a>
      </div>
        <ul>
          <li><a href="terminology.html">Terminology</a></li>
          <li class="nav-section">
            <div class="nav-section-header">
              <a href="implement.html">
                <span class="en">Implementation</span>
              </a>
            </div>
            <ul>
              <li><a href="implement-policy.html">Policy Configuration</a></li>
              <li><a href="implement-shared-library.html">Shared Library</a></li>
              <li><a href="implement-pre-processing.html">Pre-processing Effects</a></li>
            </ul>
         </li>
          <li><a href="data_formats.html">Data Formats</a></li>
          <li><a href="attributes.html">Attributes</a></li>
          <li><a href="warmup.html">Warmup</a></li>
          <li class="nav-section">
            <div class="nav-section-header">
              <a href="latency.html">
                <span class="en">Latency</span>
              </a>
            </div>
            <ul>
              <li><a href="latency_contrib.html">Contributors</a></li>
              <li><a href="latency_design.html">Design</a></li>
              <li><a href="latency_measure.html">Measure</a></li>
              <li><a href="testing_circuit.html">Light Testing Circuit</a></li>
              <li><a href="loopback.html">Audio Loopback Dongle</a></li>
              <li><a href="latency_measurements.html">Measurements</a></li>
              <li><a href="latency_app.html">Applications</a></li>
            </ul>
          </li>
          <li><a href="avoiding_pi.html">Priority Inversion</a></li>
          <li><a href="src.html">Sample Rate Conversion</a></li>
          <li><a href="debugging.html">Debugging</a></li>
          <li class="nav-section">
            <div class="nav-section-header">
              <a href="midi.html">
                <span class="em">MIDI</span>
              </a>
            </div>
            <ul>
              <li><a href="midi_arch.html">MIDI Architecture</a></li>
              <li><a href="midi_test.html">MIDI Test Procedure</a></li>
            </ul>
          <li><a href="usb.html">USB Digital Audio</a></li>
          <li><a href="tv.html">TV Audio</a></li>
        </ul>
      </li>
      <li><a href="../automotive.html">Automotive</a></li>
      <li><a href="../bluetooth.html">Bluetooth</a></li>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../camera/index.html">
            <span class="en">Camera</span>
          </a>
        </div>
        <ul>
          <li><a href="../camera/camera3.html">Camera HAL3</a></li>
          <li><a href="../camera/camera3_requests_hal.html">HAL Subsystem</a></li>
          <li><a href="../camera/camera3_metadata.html">Metadata and Controls</a></li>
          <li><a href="../camera/camera3_3Amodes.html">3A Modes and State</a></li>
          <li><a href="../camera/camera3_crop_reprocess.html">Output and Cropping</a></li>
          <li><a href="../camera/camera3_error_stream.html">Errors and Streams</a></li>
          <li><a href="../camera/camera3_requests_methods.html">Request Creation</a></li>
          <li><a href="../camera/versioning.html">Version Support</a></li>
        </ul>
      </li>

      <li><a href="../drm.html">DRM</a></li>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../graphics/index.html">
            <span class="en">Graphics</span>
          </a>
        </div>
        <ul>
         <li class="nav-section">
            <div class="nav-section-header">
              <a href="../graphics/architecture.html">
                <span class="en">Architecture</span>
              </a>
            </div>
            <ul>
              <li><a href="../graphics/arch-bq-gralloc.html">BufferQueue</a></li>
              <li><a href="../graphics/arch-sf-hwc.html">SurfaceFlinger and HWC</a></li>
              <li><a href="../graphics/arch-sh.html">Surface and SurfaceHolder</a></li>
              <li><a href="../graphics/arch-egl-opengl.html">OpenGL ES</a></li>
              <li><a href="../graphics/arch-vulkan.html">Vulkan</a></li>
              <li><a href="../graphics/arch-sv-glsv.html">SurfaceView</a></li>
              <li><a href="../graphics/arch-st.html">SurfaceTexture</a></li>
              <li><a href="../graphics/arch-tv.html">TextureView</a></li>
              <li><a href="../graphics/arch-gameloops.html">Game Loops</a></li>
            </ul>
         </li>
         <li class="nav-section">
            <div class="nav-section-header">
              <a href="../graphics/implement.html">
                <span class="en">Implementing</span>
              </a>
            </div>
            <ul>
              <li><a href="../graphics/implement-hwc.html">Hardware Composer HAL</a></li>
              <li><a href="../graphics/implement-vsync.html">VSYNC</a></li>
              <li><a href="../graphics/implement-vulkan.html">Vulkan</a></li>
              <li><a href="../graphics/implement-vdisplays.html">Virtual Displays</a></li>
            </ul>
         </li>
         <li class="nav-section">
            <div class="nav-section-header">
              <a href="../graphics/testing.html">
                <span class="en">OpenGL ES Testing</span>
              </a>
            </div>
            <ul>
              <li><a href="../graphics/build-tests.html">Building test programs</a></li>
              <li><a href="../graphics/port-tests.html">Porting the test framework</a></li>
              <li><a href="../graphics/run-tests.html">Running the tests</a></li>
              <li><a href="../graphics/automate-tests.html">Automating the tests</a></li>
              <li><a href="../graphics/test-groups.html">Using special test groups</a></li>
              <li><a href="../graphics/cts-integration.html">Integrating with Android CTS</a></li>
            </ul>
         </li>
        </ul> </li>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../input/index.html">
            <span class="en">Input</span>
          </a>
        </div>
        <ul>
          <li><a href="../input/overview.html">Overview</a></li>
          <li><a href="../input/key-layout-files.html">Key Layout Files</a></li>
          <li><a href="../input/key-character-map-files.html">Key Character Map Files</a></li>
          <li><a href="../input/input-device-configuration-files.html">Input Device Configuration Files</a></li>
          <li><a href="../input/migration-guide.html">Migration Guide</a></li>
          <li><a href="../input/keyboard-devices.html">Keyboard Devices</a></li>
          <li><a href="../tech/input/touch-devices.html">Touch Devices</a></li>
          <li><a href="../tech/input/dumpsys.html">Diagnostics</a></li>
          <li><a href="../input/getevent.html">Getevent</a></li>
          <li><a href="../input/validate-keymaps.html">Validate Keymaps</a></li>
        </ul>
      </li>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../media.html">
            <span class="en">Media</span>
          </a>
        </div>
        <ul>
          <li><a href="../media/framework-hardening.html">Framework
          Hardening</a></li>
          <li><a href="../media/soc.html">SoC Dependencies</a></li>
          <li><a href="../media/oem.html">OEM Dependencies</a></li>
        </ul>
      </li>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../sensors/index.html">
            <span class="en">Sensors</span>
          </a>
        </div>
        <ul>
          <li><a href="../sensors/sensor-stack.html">Sensor stack</a></li>
          <li><a href="../sensors/report-modes.html">Reporting modes</a></li>
          <li><a href="../sensors/suspend-mode.html">Suspend mode</a></li>
          <li><a href="../sensors/power-use.html">Power consumption</a></li>
          <li><a href="../sensors/interaction.html">Interaction</span></a></li>
          <li><a href="../sensors/hal-interface.html">HAL interface</a></li>
          <li><a href="../sensors/batching.html">Batching</a></li>
          <li><a href="../sensors/sensor-types.html">Sensor types</a></li>
          <li><a href="../sensors/versioning.html">Version deprecation</a></li>
        </ul>
      </li>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="https://source.android.com/devices/storage/index.html">
            <span class="en">Storage</span>
          </a>
        </div>
        <ul>
          <li><a href="../storage/traditional.html">Traditional Storage</a></li>
          <li><a href="../storage/adoptable.html">Adoptable Storage</a></li>
          <li><a href="../storage/config.html">Device Configuration</a></li>
          <li><a href="../storage/config-example.html">Configuration Examples</a></li>
        </ul>
      </li>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../tv/index.html">
            <span class="en">TV</span>
          </a>
        </div>
        <ul>
          <li><a href="../tv/HDMI-CEC.html">HDMI-CEC control service</a></li>
          <li><a href="../tv/reference-tv-app.html">Reference TV App</a></li>
        </ul>
      </li>
    </ul>
  </li> <!-- End nav-section, Device Interfaces-->


  <li class="nav-section"> <!--Begin nav-section, Core Technologies-->
    <div class="nav-section-header">
      <a href="../tech/index.html">
        <span class="en">Core Technologies</span>
      </a>
    </div>

    <ul>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../tech/dalvik/index.html">
          <span class="en">ART and Dalvik</span></a>
        </div>
        <ul>
          <li><a href="../tech/dalvik/dalvik-bytecode.html">Bytecode Format</a></li>
          <li><a href="../tech/dalvik/dex-format.html">.Dex Format</a></li>
          <li><a href="../tech/dalvik/instruction-formats.html">Instruction Formats</a></li>
          <li><a href="../tech/dalvik/constraints.html">Constraints</a></li>
          <li><a href="../tech/dalvik/configure.html">Configuration</a></li>
          <li><a href="../tech/dalvik/gc-debug.html">Garbage Collection</a></li>
          <li><a href="../tech/dalvik/jit-compiler.html">JIT Compilation</a></li>
        </ul>
      </li>

      <li class="nav-section">
        <div class="nav-section-header">
            <a href="../tech/config/index.html">
              <span class="en">Configuration</span>
            </a>
        </div>
        <ul>
          <li><a href="../tech/config/carrier.html">Carrier Customization</a></li>
          <li><a href="../tech/config/connect_tests.html">Connectivity Tests</a></li>
          <li><a href="../tech/config/filesystem.html">File System</a></li>
          <li><a href="../tech/kernel.html">Kernel Configuration</a></li>
          <li><a href="../tech/config/kernel_network_tests.html">Kernel Network Tests</a></li>
          <li><a href="../tech/config/low-ram.html">Low RAM</a></li>
          <li><a href="../tech/config/namespaces_libraries.html">Namespaces for Libraries</a></li>
          <li><a href="../tech/config/renderer.html">OpenGLRenderer</a></li>
          <li><a href="../tech/config/runtime_perms.html">Runtime Permissions</a></li>
          <li><a href="../tech/config/uicc.html">UICC</a></li>
          <li><a href="../tech/config/voicemail.html">Visual Voicemail</a></li>
        </ul>
      </li>

      <li class="nav-section">
        <div class="nav-section-header">
            <a href="../tech/connect/index.html">
              <span class="en">Connectivity</span>
            </a>
        </div>
        <ul>
          <li><a href="../tech/connect/block-numbers.html">Block Phone Numbers</a></li>
          <li><a href="../tech/connect/call-notification.html">Call Notifications</a></li>
          <li><a href="../tech/connect/data-saver.html">Data Saver Mode</a></li>
          <li><a href="../tech/connect/emergency-affordance.html">Emergency Affordance</a></li>
          <li><a href="../tech/connect/felica.html">Host Card Emulation of FeliCa</a></li>
          <li><a href="../tech/connect/ril.html">Radio Interface Layer (RIL)</a></li>
        </ul>
      </li>

      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../tech/datausage/index.html">
            <span class="en">Data Usage</span>
          </a>
        </div>
        <ul>
          <li><a href="../tech/datausage/iface-overview.html">Network interface statistics overview</a></li>
          <li><a href="../tech/datausage/excluding-network-types.html">Excluding Network Types from Data Usage</a></li>
          <li><a href="../tech/datausage/tethering-data.html">Tethering Data</a></li>
          <li><a href="../tech/datausage/usage-cycle-resets-dates.html">Usage Cycle Reset Dates</a></li>
          <li><a href="../tech/datausage/kernel-overview.html">Kernel Overview</a></li>
          <li><a href="../tech/datausage/tags-explained.html">Data Usage Tags Explained</a></li>
          <li><a href="../tech/datausage/kernel-changes.html">Kernel Changes</a></li>
        </ul>
      </li>

      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../tech/debug/index.html">
            <span class="en">Debugging</span>
          </a>
        </div>
        <ul>
          <li><a href="../tech/debug/asan.html">AddressSanitizer</a></li>
          <li><a href="../tech/debug/dumpsys.html">Dumpsys</a></li>
          <li><a href="../tech/debug/native-memory.html">Native Memory Use</a></li>
          <li><a href="../tech/debug/netstats.html">Network Use</a></li>
          <li><a href="../tech/debug/procstats.html">RAM Use</a></li>
        </ul>
      </li>

      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../tech/admin/index.html">
          <span class="en">Device Administration</span></a>
        </div>
        <ul>
          <li><a href="../tech/admin/implement.html">Implementation</a></li>
          <li><a href="../tech/admin/multi-user.html">Multiple Users</a></li>
          <li><a href="../tech/admin/managed-profiles.html">Managed Profiles</a></li>
          <li><a href="../tech/admin/provision.html">Provisioning</a></li>
          <li><a href="../tech/admin/multiuser-apps.html">Multiuser Apps</a></li>
          <li><a href="../tech/admin/enterprise-telephony.html">Enterprise Telephony</a></li>
          <li><a href="../tech/admin/testing-provision.html">Testing Device Provisioning</a></li>
          <li><a href="../tech/admin/testing-setup.html">Testing Device Administration</a></li>
        </ul>
      </li>

      <li class="nav-section">
        <div class="nav-section-header">
            <a href="../tech/display/index.html">
              <span class="en">Display Settings</span></a>
        </div>
        <ul>
          <li><a href="../tech/display/dnd.html">Do Not Disturb</a></li>
          <li><a href="../tech/display/multi-window.html">Multi-Window</a></li>
          <li><a href="../tech/display/hdr.html">HDR Video</a></li>
        </ul>
      </li>

      <li class="nav-section">
        <div class="nav-section-header empty">
          <a href="../halref/index.html">
            <span class="en">HAL File Reference</span>
          </a>
        </div>
      </li>

      <li class="nav-section">
        <div class="nav-section-header">
            <a href="../tech/ota/index.html">
              <span class="en">OTA Updates</span>
            </a>
        </div>
        <ul>
          <li><a href="../tech/ota/tools.html">OTA Tools</a></li>
          <li><a href="../tech/ota/block.html">Block-based OTA</a></li>
          <li><a href="../tech/ota/inside_packages.html">Inside OTA Packages</a></li>
          <li><a href="../tech/ota/device_code.html">Device-Specific Code</a></li>
          <li><a href="../tech/ota/reduce_size.html">Reducing OTA Size</a></li>
          <li><a href="../tech/ota/sign_builds.html">Signing Builds for Release</a></li>
          <li><a href="../tech/ota/ab_updates.html">A/B System Updates</a></li>
        </ul>
      </li>

      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../tech/power/index.html"><span class="en">Power</span></a>
        </div>
        <ul>
          <li><a href="../tech/power/mgmt.html">Power Management</a></li>
          <li><a href="../tech/power/performance.html">Performance Management</a></li>
          <li><a href="../tech/power/component.html">Component Power</a></li>
          <li><a href="../tech/power/device.html">Device Power</a></li>
          <li><a href="../tech/power/values.html">Power Values</a></li>
          <li><a href="../tech/power/batterystats.html">Battery Use</a>
          </li>
        </ul>
      </li>
      <li class="nav-section">
        <div class="nav-section-header">
          <a href="../tech/test_infra/tradefed/index.html">
            <span class="en">Testing Infrastructure</span>
          </a>
        </div>
        <ul>
          <li><a href="../tech/test_infra/tradefed/fundamentals/index.html">Start Here</a></li>
          <li><a href="../tech/test_infra/tradefed/fundamentals/machine_setup.html">Machine Setup</a></li>
          <li><a href="../tech/test_infra/tradefed/fundamentals/devices.html">Working with Devices</a></li>
          <li><a href="../tech/test_infra/tradefed/fundamentals/lifecycle.html">Test Lifecycle</a></li>
          <li><a href="../tech/test_infra/tradefed/fundamentals/options.html">Option Handling</a></li>
          <li><a href="../tech/test_infra/tradefed/full_example.html">An End-to-End Example</a></li>
          <li id="tradefed-tree-list" class="nav-section">
            <div class="nav-section-header">
              <a href="../../reference/packages.html">
                <span class="en">Package Index</span>
              </a>
            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li> <!-- End nav-section, Core Technologies -->
</ul> 


      </div>
      <script type="text/javascript">
        showTradefedRefTree();
      </script>
    </div> <!-- end side-nav -->
    <script>
      $(document).ready(function() {
        scrollIntoView("devdoc-nav");
        });
    </script>

  




<div class="col-12" id="doc-col" >


  
    
      
        <h1 itemprop="name" >Audio Debugging</h1>
      
    
  


  
  <div id="jd-content">

    <div class="jd-descr" itemprop="articleBody">
    <!--
    Copyright 2013 The Android Open Source Project

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<div id="qv-wrapper">
  <div id="qv">
    <h2>In this document</h2>
    <ol id="auto-toc">
    </ol>
  </div>
</div>

<p>
This article describes some tips and tricks for debugging Android audio.
</p>

<h2 id="teeSink">Tee Sink</h2>

<p>
The "tee sink" is
an AudioFlinger debugging feature, available in custom builds only,
for retaining a short fragment of recent audio for later analysis.
This permits comparison between what was actually played or recorded
vs. what was expected.
</p>

<p>
For privacy the tee sink is disabled by default, at both compile-time and
run-time.  To use the tee sink, you will need to enable it by re-compiling,
and also by setting a property.  Be sure to disable this feature after you are
done debugging; the tee sink should not be left enabled in production builds.
</p>

<p>
The instructions in the remainder of this section are for Android 5.x and 6.x.
For Android 7.x, replace <code>/data/misc/media</code> with
<code>/data/misc/audioserver</code>.
Additionally, you must use a userdebug or eng build.
If you use a userdebug build, then disable verity with:</p>
<pre>
<code>$ adb root &amp;&amp; adb disable-verity &amp;&amp; adb reboot</code>
</pre>

<h3 id="compile">Compile-time setup</h3>

<ol>
<li><code>$ cd frameworks/av/services/audioflinger</code></li>
<li>Edit <code>Configuration.h</code>.</li>
<li>Uncomment <code>#define TEE_SINK</code>.</li>
<li>Re-build <code>libaudioflinger.so</code>.</li>
<li><code>$ adb root</code></li>
<li><code>$ adb remount</code></li>
<li>Push or sync the new <code>libaudioflinger.so</code> to the device's <code>/system/lib</code>.</li>
</ol>

<h3 id="runtime">Run-time setup</h3>

<ol>
<li><code>$ adb shell getprop | grep ro.debuggable</code>
<br />Confirm that the output is: <code>[ro.debuggable]: [1]</code>
</li>
<li><code>$ adb shell</code></li>
<li><code>$ ls -ld /data/misc/media</code>
<br />
<p>
Confirm that the output is:
</p>
<pre>
drwx------ media media ... media
</pre>
<br />
<p>
If the directory does not exist, create it as follows:
</p>
<pre>
$ mkdir /data/misc/media
$ chown media:media /data/misc/media
</pre>
</li>
<li><code>$ echo af.tee=# &gt; /data/local.prop</code>
<br />Where the <code>af.tee</code> value is a number described below.
</li>
<li><code>$ chmod 644 /data/local.prop</code></li>
<li><code>$ reboot</code></li>
</ol>

<h4>Values for <code>af.tee</code> property</h4>

<p>
The value of <code>af.tee</code> is a number between 0 and 7, expressing
the sum of several bits, one per feature.
See the code at <code>AudioFlinger::AudioFlinger()</code> in <code>AudioFlinger.cpp</code>
for an explanation of each bit, but briefly:
</p>
<ul>
<li>1 = input</li>
<li>2 = FastMixer output</li>
<li>4 = per-track AudioRecord and AudioTrack</li>
</ul>

<p>
There is no bit for deep buffer or normal mixer yet,
but you can get similar results using "4."
</p>

<h3 id="test">Test and acquire data</h3>

<ol>
<li>Run your audio test.</li>
<li><code>$ adb shell dumpsys media.audio_flinger</code></li>
<li>Look for a line in dumpsys output such as this:<br />
<code>tee copied to /data/misc/media/20131010101147_2.wav</code>
<br />This is a PCM .wav file.
</li>
<li>Then <code>adb pull</code> any <code>/data/misc/media/*.wav</code> files of interest;
note that track-specific dump filenames do not appear in the dumpsys output,
but are still saved to <code>/data/misc/media</code> upon track closure.
</li>
<li>Review the dump files for privacy concerns before sharing with others.</li>
</ol>

<h4>Suggestions</h4>

<p>Try these ideas for more useful results:</p>

<ul>
<li>Disable touch sounds and key clicks to reduce interruptions in test output.</li>
<li>Maximize all volumes.</li>
<li>Disable apps that make sound or record from microphone,
if they are not of interest to your test.
</li>
<li>Track-specific dumps are only saved when the track is closed;
you may need to force close an app in order to dump its track-specific data
</li>
<li>Do the <code>dumpsys</code> immediately after test;
there is a limited amount of recording space available.</li>
<li>To make sure you don't lose your dump files,
upload them to your host periodically.
Only a limited number of dump files are preserved;
older dumps are removed after that limit is reached.</li>
</ul>

<h3 id="restore">Restore</h3>

<p>
As noted above, the tee sink feature should not be left enabled.
Restore your build and device as follows:
</p>
<ol>
<li>Revert the source code changes to <code>Configuration.h</code>.</li>
<li>Re-build <code>libaudioflinger.so</code>.</li>
<li>Push or sync the restored <code>libaudioflinger.so</code>
to the device's <code>/system/lib</code>.
</li>
<li><code>$ adb shell</code></li>
<li><code>$ rm /data/local.prop</code></li>
<li><code>$ rm /data/misc/media/*.wav</code></li>
<li><code>$ reboot</code></li>
</ol>

<h2 id="mediaLog">media.log</h2>

<h3 id="alogx">ALOGx macros</h3>

<p>
The standard Java language logging API in Android SDK is
<a href="http://developer.android.com/reference/android/util/Log.html">android.util.Log</a>.
</p>

<p>
The corresponding C language API in Android NDK is
<code>__android_log_print</code>
declared in <code>&lt;android/log.h&gt;</code>.
</p>

<p>
Within the native portion of Android framework, we
prefer macros named <code>ALOGE</code>, <code>ALOGW</code>,
<code>ALOGI</code>, <code>ALOGV</code>, etc.  They are declared in
<code>&lt;utils/Log.h&gt;</code>, and for the purposes of this article
we'll collectively refer to them as <code>ALOGx</code>.
</p>

<p>
All of these APIs are easy-to-use and well-understood, so they are pervasive
throughout the Android platform.  In particular the <code>mediaserver</code>
process, which includes the AudioFlinger sound server, uses
<code>ALOGx</code> extensively.
</p>

<p>
Nevertheless, there are some limitations to <code>ALOGx</code> and friends:
</p>

<ul>
<li>
They are susceptible to "log spam": the log buffer is a shared resource
so it can easily overflow due to unrelated log entries, resulting in
missed information.  The <code>ALOGV</code> variant is disabled at
compile-time by default.  But of course even it can result in log spam
if it is enabled.
</li>
<li>
The underlying kernel system calls could block, possibly resulting in
priority inversion and consequently measurement disturbances and
inaccuracies.  This is of
special concern to time-critical threads such as <code>FastMixer</code> and <code>FastCapture</code>.
</li>
<li>
If a particular log is disabled to reduce log spam,
then any information that would have been captured by that log is lost.
It is not possible to enable a specific log retroactively,
<i>after</i> it becomes clear that the log would have been interesting.
</li>
</ul>

<h3 id="nblog">NBLOG, media.log, and MediaLogService</h3>

<p>
The <code>NBLOG</code> APIs and associated <code>media.log</code>
process and <code>MediaLogService</code>
service together form a newer logging system for media, and are specifically
designed to address the issues above.  We will loosely use the term
"media.log" to refer to all three, but strictly speaking <code>NBLOG</code> is the
C++ logging API, <code>media.log</code> is a Linux process name, and <code>MediaLogService</code>
is an Android binder service for examining the logs.
</p>

<p>
A <code>media.log</code> "timeline" is a series
of log entries whose relative ordering is preserved.
By convention, each thread should use it's own timeline.
</p>

<h3 id="benefits">Benefits</h3>

<p>
The benefits of the <code>media.log</code> system are that it:
</p>
<ul>
<li>Doesn't spam the main log unless and until it is needed.</li>
<li>Can be examined even when <code>mediaserver</code> crashes or hangs.</li>
<li>Is non-blocking per timeline.</li>
<li>Offers less disturbance to performance.
(Of course no form of logging is completely non-intrusive.)
</li>
</ul>

<h3 id="architecture">Architecture</h3>

<p>
The diagram below shows the relationship of the <code>mediaserver</code> process
and the <code>init</code> process, before <code>media.log</code> is introduced:
</p>
<img src="images/medialog_before.png" alt="Architecture before media.log" id="figure1" />
<p class="img-caption">
  <strong>Figure 1.</strong> Architecture before media.log
</p>

<p>
Notable points:
</p>
<ul>
<li><code>init</code> forks and execs <code>mediaserver</code>.</li>
<li><code>init</code> detects the death of <code>mediaserver</code>, and re-forks as necessary.</li>
<li><code>ALOGx</code> logging is not shown.</li>
</ul>

<p>
The diagram below shows the new relationship of the components,
after <code>media.log</code> is added to the architecture:
</p>
<img src="images/medialog_after.png" alt="Architecture after media.log" id="figure2" />
<p class="img-caption">
  <strong>Figure 2.</strong> Architecture after media.log
</p>

<p>
Important changes:
</p>

<ul>

<li>
Clients use <code>NBLOG</code> API to construct log entries and append them to
a circular buffer in shared memory.
</li>

<li>
<code>MediaLogService</code> can dump the contents of the circular buffer at any time.
</li>

<li>
The circular buffer is designed in such a way that any corruption of the
shared memory will not crash <code>MediaLogService</code>, and it will still be able
to dump as much of the buffer that is not affected by the corruption.
</li>

<li>
The circular buffer is non-blocking and lock-free for both writing
new entries and reading existing entries.
</li>

<li>
No kernel system calls are required to write to or read from the circular buffer
(other than optional timestamps).
</li>

</ul>

<h4>Where to use</h4>

<p>
As of Android 4.4, there are only a few log points in AudioFlinger
that use the <code>media.log</code> system.  Though the new APIs are not as
easy to use as <code>ALOGx</code>, they are not extremely difficult either.
We encourage you to learn the new logging system for those
occasions when it is indispensable.
In particular, it is recommended for AudioFlinger threads that must
run frequently, periodically, and without blocking such as the
<code>FastMixer</code> and <code>FastCapture</code> threads.
</p>

<h3 id="how">How to use</h3>

<h4>Add logs</h4>

<p>
First, you need to add logs to your code.
</p>

<p>
In <code>FastMixer</code> and <code>FastCapture</code> threads, use code such as this:
</p>
<pre>
logWriter-&gt;log("string");
logWriter-&gt;logf("format", parameters);
logWriter-&gt;logTimestamp();
</pre>
<p>
As this <code>NBLog</code> timeline is used only by the <code>FastMixer</code> and
<code>FastCapture</code> threads,
there is no need for mutual exclusion.
</p>

<p>
In other AudioFlinger threads, use <code>mNBLogWriter</code>:
</p>
<pre>
mNBLogWriter-&gt;log("string");
mNBLogWriter-&gt;logf("format", parameters);
mNBLogWriter-&gt;logTimestamp();
</pre>
<p>
For threads other than <code>FastMixer</code> and <code>FastCapture</code>,
the thread's <code>NBLog</code> timeline can be used by both the thread itself, and
by binder operations.  <code>NBLog::Writer</code> does not provide any
implicit mutual exclusion per timeline, so be sure that all logs occur
within a context where the thread's mutex <code>mLock</code> is held.
</p>

<p>
After you have added the logs, re-build AudioFlinger.
</p>

<p class="caution"><strong>Caution:</strong>
A separate <code>NBLog::Writer</code> timeline is required per thread,
to ensure thread safety, since timelines omit mutexes by design.  If you
want more than one thread to use the same timeline, you can protect with an
existing mutex (as described above for <code>mLock</code>).  Or you can
use the <code>NBLog::LockedWriter</code> wrapper instead of <code>NBLog::Writer</code>.
However, this negates a prime benefit of this API: its non-blocking
behavior.
</p>

<p>
The full <code>NBLog</code> API is at <code>frameworks/av/include/media/nbaio/NBLog.h</code>.
</p>

<h4>Enable media.log</h4>

<p>
<code>media.log</code> is disabled by default. It is active only when property
<code>ro.test_harness</code> is <code>1</code>.  You can enable it by:
</p>

<pre>
$ adb root
$ adb shell
$ echo ro.test_harness=1 > /data/local.prop
$ chmod 644 /data/local.prop
$ reboot
</pre>

<p>
The connection is lost during reboot, so:
</p>
<pre>
$ adb shell
</pre>

The command <code>ps media</code> will now show two processes:
<ul>
<li>media.log</li>
<li>mediaserver</li>
</ul>
<p>
Note the process ID of <code>mediaserver</code> for later.
</p>

<h4>Displaying the timelines</h4>

<p>
You can manually request a log dump at any time.
This command shows logs from all the active and recent timelines, and then clears them:
</p>
<pre>
$ dumpsys media.log
</pre>

<p>
Note that by design timelines are independent,
and there is no facility for merging timelines.
</p>

<h4>Recovering logs after mediaserver death</h4>

<p>
Now try killing <code>mediaserver</code> process: <code>kill -9 #</code>, where # is
the process ID you noted earlier.  You should see a dump from <code>media.log</code>
in the main <code>logcat</code>, showing all the logs leading up to the crash.
</p>
<pre>
$ dumpsys media.log
</pre>

    </div>

      <div class="content-footer-sac"
                    itemscope itemtype="http://schema.org/SiteNavigationElement">
        <div class="layout-content-col col-9" style="padding-top:4px">
        </div>
        
        <div class="paging-links layout-content-col col-4">
          
        </div>
        
      </div>
      
      
    </div> <!-- end jd-content -->
  <div id="footer" class="wrap" >
  <style>.feedback { float: right !Important }</style>
  <div class="feedback">
    <a href="debugging.html#" class="button" onclick=" try {
      userfeedback.api.startFeedback({'productId':'715571','authuser':'1'});return false;}catch(e){}">Site Feedback</a>
  </div>
  <div id="copyright">
    
  Except as noted, this content is 
  licensed under <a href="http://creativecommons.org/licenses/by/2.5/">
  Creative Commons Attribution 2.5</a>. For details and 
  restrictions, see the <a href="../../license.html">Content 
  License</a>.
  </div>
    <div id="footerlinks">
    
  <p>
    <a href="../../source/index.html">About Android</a>&nbsp;&nbsp;|&nbsp;
    <a href="../../source/community.html">Community</a>&nbsp;&nbsp;|&nbsp;
    <a href="../../legal.html">Legal</a>&nbsp;&nbsp;|&nbsp;
  </p>
  </div>

</div><!-- end doc-content -->

</div> <!-- end body-content --> 






</body>
</html>



